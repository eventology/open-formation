{
  "config": {
    "type": "t2.small",
    "imageName": "ubuntu/images/hvm-ssd/ubuntu-xenial-16.04-amd64-server-20170414",
    "keyName": "cosmunity",
    "region": "us-west-1"
  },
  "scripts": {
    "default": [
      "export DEBIAN_FRONTEND=noninteractive",
      "sudo apt-get update",
      "sudo apt-get install -y apt-transport-https ca-certificates curl software-properties-common",
      "curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -",
      "sudo add-apt-repository \"deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\"",
      "sudo apt-get update",
      "sudo apt-get install -y docker-ce",
      "sudo usermod -aG docker ubuntu"
    ],
    "createSwarm": [
      "<% console.log(`This is a test swarm, I, ${c.ip}, am the manager`) %>",
      "docker swarm init --advertise-addr $(curl checkip.amazonaws.com)",
      "<% wait(5000) %>"
    ],
    "joinSwarm": [
      "<% tokenCommand = `docker swarm join-token worker -q` %>",
      "<% i.manager.ssh(tokenCommand, true).then(_token => token = _token) %>",
      "docker swarm join --token <% print(token) %> <% print(i.manager.ip) %>:2377",
      "<% wait(2000) %>",
      "<% labels = _.reduce(c.tags, (c, v, k) => `--label-add ${k}=${v} ${c}`, '') %>",
      "<% nodeIdCommand = `curl --unix-socket '/var/run/docker.sock' 'http:/info'` %>",
      "<% c.ssh(nodeIdCommand, true).then(_info => info = JSON.parse(_info)) %>",
      "<% i.manager.ssh(`docker node update ${_.get(info, 'Swarm.NodeID')} ${labels}`) %>"
    ]
  },
  "machines": {
    "manager": {
      "__boot__": [
        "createSwarm"
      ]
    },
    "worker1": {
      "__boot__": [
        "joinSwarm"
      ],
      "tags": {
        "backend": "allow",
        "chat": "allow"
      }
    },
    "worker2": {
      "__boot__": [
        "joinSwarm"
      ],
      "tags": {
        "backend": "allow",
        "chat": "allow"
      }
    },
    "worker3": {
      "__boot__": [
        "joinSwarm"
      ],
      "tags": {
        "backend": "allow",
        "chat": "allow"
      }
    }
  }
}
