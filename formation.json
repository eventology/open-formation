{
  "config": {
    "type": "t2.small",
    "imageName": "ubuntu/images/hvm-ssd/ubuntu-xenial-16.04-amd64-server-20170414",
    "keyName": "cosmunity"
  },
  "scripts": {
    "default": [
      "export DEBIAN_FRONTEND=noninteractive",
      "sudo apt-get update",
      "sudo apt-get install -y apt-transport-https ca-certificates curl software-properties-common",
      "curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -",
      "sudo add-apt-repository \"deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\"",
      "sudo apt-get update",
      "sudo apt-get install -y docker-ce",
      "sudo usermod -aG docker ubuntu"
    ],
    "joinSwarm": [
      "docker swarm join --token <% print(i.manager.ssh('docker swarm join-token worker -q')) %> <% print(i.manager.ip) %>:2377",
      "sleep 3"
    ],
    "createSwarm": [
      "docker swarm init --advertise-addr $(curl checkip.amazonaws.com)",
      "sleep 3"
    ],
    "swarmLabels": [
      "<% nodeIdCommand = `docker info | grep NodeID | awk '{print $2}' | tr '\\n' '\\0'` %>",
      "<% labels = _.reduce(c.tags, (c, v, k) => `--label-add ${k}=${v} ${c}`, '') %>",
      "<% c.ssh(nodeIdCommand).then(id => nodeId = id) %>",
      "<% i.manager.ssh(`docker node update ${nodeId} ${labels}`) %>"
    ]
  },
  "machines": {
    "manager": {
      "__boot__": [
        "createSwarm"
      ],
      "region": "us-west-1"
    },
    "of-machine": {
      "__boot__": [
        "joinSwarm",
        "swarmLabels"
      ],
      "tags": {
        "backend": "allow",
        "chat": "allow"
      },
      "region": "us-west-1"
    }
  }
}
